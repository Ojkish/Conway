<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cellularium - Pro</title>
    <style>
        :root {
            --bg: #050505;
            --panel-bg: rgba(22, 27, 34, 0.85); /* Semi-transparent */
            --panel-border: rgba(48, 54, 61, 0.5);
            --text: #e6edf3;
            --text-dim: #7d8590;
            --accent: #58a6ff;
            --accent-glow: rgba(88, 166, 255, 0.3);
            --danger: #f85149;
            --success: #2ea043;
            --radius: 8px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg); color: var(--text);
            display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
        }

        /* --- STYLED INPUTS (Custom Range) --- */
        input[type=range] {
            -webkit-appearance: none; width: 100%; background: transparent; height: 20px; cursor: pointer;
        }
        input[type=range]:focus { outline: none; }
        
        /* Piste du slider */
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer;
            background: #30363d; border-radius: 3px;
        }
        input[type=range]::-moz-range-track {
            width: 100%; height: 6px; cursor: pointer;
            background: #30363d; border-radius: 3px;
        }
        
        /* Bouton du slider (Thumb) */
        input[type=range]::-webkit-slider-thumb {
            height: 18px; width: 18px; border-radius: 50%;
            background: var(--text); border: 2px solid var(--bg);
            cursor: pointer; -webkit-appearance: none;
            margin-top: -6px; /* Alignement vertical */
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        input[type=range]::-moz-range-thumb {
            height: 18px; width: 18px; border: none; border-radius: 50%;
            background: var(--text); cursor: pointer;
        }

        select {
            background: #21262d; border: 1px solid var(--panel-border);
            color: white; border-radius: var(--radius); height: 36px; padding: 0 10px;
            font-size: 14px; width: 100%; appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat; background-position: right 10px center; background-size: 10px;
        }

        /* --- BUTTONS --- */
        button {
            border: 1px solid var(--panel-border); border-radius: var(--radius);
            background: #21262d; color: var(--text); cursor: pointer;
            font-weight: 600; font-size: 0.9rem; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        button:active { transform: scale(0.96); }
        
        /* Bouton Play Actif */
        button.is-playing {
            background: rgba(46, 160, 67, 0.15);
            color: var(--success);
            border-color: var(--success);
            box-shadow: 0 0 10px rgba(46, 160, 67, 0.2);
        }
        
        button.danger { color: var(--danger); }
        button.danger:hover { background: rgba(248, 81, 73, 0.1); border-color: var(--danger); }

        /* --- LAYOUT --- */
        #top-bar {
            background: var(--panel-bg); 
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--panel-border);
            padding: 10px 15px; display: flex; flex-direction: column; gap: 12px;
            z-index: 20; box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .controls-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
        }

        .label-row {
            display: flex; justify-content: space-between; align-items: baseline;
            margin-bottom: 5px; color: var(--text-dim); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;
        }

        /* --- GRAPH & STATS --- */
        #stats-strip {
            display: flex; align-items: center; justify-content: space-between;
            padding-top: 8px; border-top: 1px solid var(--panel-border);
            font-size: 0.85rem; font-family: 'SF Mono', 'Consolas', monospace; /* Monospace pour √©viter le tremblement */
        }
        
        #graph-container {
            width: 120px; height: 36px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px; overflow: hidden;
            border: 1px solid var(--panel-border);
            position: relative;
        }

        /* --- VIEWPORT --- */
        #viewport {
            flex: 1; position: relative;
            background-image: radial-gradient(#1a1a1a 1px, transparent 1px);
            background-size: 20px 20px; /* Petit motif de fond subtil */
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        
        #canvas-wrapper {
            box-shadow: 0 0 60px rgba(0,0,0,0.6);
            border: 1px solid #333;
            background: #000;
            transition: box-shadow 0.3s;
        }

        /* --- BOTTOM BAR --- */
        #bottom-bar {
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--panel-border);
            padding: 10px 15px; z-index: 20;
            padding-bottom: max(10px, env(safe-area-inset-bottom));
        }

        .control-bar { display: flex; gap: 10px; height: 44px; }
        .btn-large { flex: 1; height: 100%; font-size: 1rem; }
        
        /* Responsive adjustments */
        @media (min-width: 700px) {
            .controls-grid { grid-template-columns: repeat(4, 1fr); align-items: end; }
            #stats-strip { justify-content: flex-end; gap: 20px; }
        }
    </style>
</head>
<body>

    <div id="top-bar">
        <div class="controls-grid">
            <div>
                <div class="label-row"><span>R√®gle</span></div>
                <select id="select-rule"></select>
            </div>
            <div>
                <div class="label-row"><span>Ins√©rer</span></div>
                <select id="select-pattern">
                    <option value="">-- Choisir --</option>
                </select>
            </div>
            <div>
                <div class="label-row"><span>Zoom</span> <span id="val-zoom" style="color:var(--accent)">10</span></div>
                <input type="range" id="range-zoom" min="2" max="40" value="10">
            </div>
            <div>
                <div class="label-row">
                    <span>Densit√©</span>
                    <button id="btn-random" style="padding: 2px 8px; height:auto; font-size:12px;">üé≤ Al√©atoire</button>
                </div>
                <input type="range" id="range-density" min="5" max="50" value="20">
            </div>
        </div>

        <div id="stats-strip">
            <div style="display:flex; gap:15px; align-items:center;">
                <span>GEN: <span id="lbl-gen" style="color:var(--accent)">0</span></span>
                <span>POP: <span id="lbl-pop">0</span></span>
            </div>
            
            <div style="display:flex; align-items:center; gap:10px;">
                <label style="display:flex; align-items:center; cursor:pointer; font-size:12px; color:var(--text-dim);">
                    <input type="checkbox" id="chk-wrap" checked style="margin-right:5px;"> Tore
                </label>
                <div id="graph-container">
                    <canvas id="population-graph" width="120" height="36"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div id="viewport">
        <div id="canvas-wrapper">
            <canvas id="grid"></canvas>
        </div>
    </div>

    <div id="bottom-bar">
        <div style="margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; color:var(--text-dim); font-size:12px;">
            <span>VITESSE</span>
            <span id="speed-val">30 fps</span>
        </div>
        <input type="range" id="range-speed" min="1" max="60" value="30" style="margin-bottom:15px;">
        
        <div class="control-bar">
            <button id="btn-play" class="btn-large">‚ñ∂ Lecture</button>
            <button id="btn-step" class="btn-large">‚èØ Pas</button>
            <button id="btn-clear" class="btn-large danger">üóë Reset</button>
        </div>
    </div>

<script>
/* --- DATA & CONFIG --- */
const RULES = {
    "life": { name: "Conway's Life", type: "life", states: 2, B: [3], S: [2,3], colors: ['#000000', '#58a6ff'] },
    "highlife": { name: "HighLife", type: "life", states: 2, B: [3,6], S: [2,3], colors: ['#000000', '#d2a8ff'] },
    "daynight": { name: "Day & Night", type: "life", states: 2, B: [3,6,7,8], S: [3,4,6,7,8], colors: ['#000000', '#ffa657'] },
    "brain": { name: "Brian's Brain", type: "gens", states: 3, B: [2], S: [], colors: ['#000000', '#7ee787', '#ff7b72'] },
    "starwars": { name: "Star Wars", type: "gens", states: 4, B: [2], S: [3,4,5], colors: ['#000000', '#79c0ff', '#1f6feb', '#ff7b72'] },
    "wireworld": { name: "WireWorld", type: "wire", states: 4, colors: ['#101010', '#ffffff', '#ff5555', '#ffcc00'] }
};

const PATTERNS = [
    { id: "glider", name: "Planeur", cat: "Classique", rule: "life", coords: [[1,0],[2,1],[0,2],[1,2],[2,2]] },
    { id: "pulsar", name: "Pulsar", cat: "Classique", rule: "life", coords: [[2,0],[3,0],[4,0],[8,0],[9,0],[10,0], [0,2],[5,2],[7,2],[12,2], [0,3],[5,3],[7,3],[12,3], [0,4],[5,4],[7,4],[12,4], [2,5],[3,5],[4,5],[8,5],[9,5],[10,5]] },
    { id: "gosper", name: "Gosper Gun", cat: "Complexe", rule: "life", coords: [[24,0],[22,1],[24,1],[12,2],[13,2],[20,2],[21,2],[34,2],[35,2],[11,3],[15,3],[20,3],[21,3],[34,3],[35,3],[0,4],[1,4],[10,4],[16,4],[20,4],[21,4],[0,5],[1,5],[10,5],[14,5],[16,5],[17,5],[22,5],[24,5],[10,6],[16,6],[24,6],[11,7],[15,7],[12,8],[13,8]] },
    { id: "butterfly", name: "Butterfly", cat: "Generations", rule: "brain", coords: [[1,0,1],[2,0,2], [0,1,2],[1,1,2],[2,1,1],[3,1,2], [1,2,2],[2,2,2],[3,2,1]] },
    { id: "logic", name: "Diode", cat: "√âlectronique", rule: "wireworld", coords: [[0,5,3],[1,5,3],[2,5,3],[3,5,3],[4,5,3],[5,5,3],[6,5,3],[7,5,3],[8,5,3],[9,5,3],[10,5,3],[1,5,1],[0,5,2],[6,4,3],[7,4,3], [6,6,3],[7,6,3], [8,5,3]] }
];

/* --- ENGINE --- */
const canvas = document.getElementById('grid');
const ctx = canvas.getContext('2d', { alpha: false });
const wrapper = document.getElementById('canvas-wrapper');

let config = { cellSize: 10, speed: 30, wrap: true, cols: 0, rows: 0 };
let grid = [], nextGrid = [];
let isPlaying = false, lastTime = 0, generation = 0;
let currentRule = RULES.life;

// Graph Vars
const graphCanvas = document.getElementById('population-graph');
const graphCtx = graphCanvas.getContext('2d');
let popHistory = new Array(60).fill(0); // Fixed size buffer

// Init UI
const ruleSelect = document.getElementById('select-rule');
Object.keys(RULES).forEach(k => ruleSelect.add(new Option(RULES[k].name, k)));

const patSelect = document.getElementById('select-pattern');
let lastCat = "";
PATTERNS.forEach(p => {
    if(p.cat !== lastCat) {
        let g = document.createElement('optgroup'); g.label = p.cat; patSelect.appendChild(g); lastCat = p.cat;
    }
    patSelect.lastChild.appendChild(new Option(p.name, p.id));
});

/* --- CORE LOGIC --- */
function getIdx(x, y) {
    if (config.wrap) { x = (x + config.cols) % config.cols; y = (y + config.rows) % config.rows; }
    else if (x < 0 || x >= config.cols || y < 0 || y >= config.rows) return -1;
    return y * config.cols + x;
}

function countNeighbors(x, y, type) {
    let n = 0;
    for(let dy=-1; dy<=1; dy++) {
        for(let dx=-1; dx<=1; dx++) {
            if(!dx && !dy) continue;
            const idx = getIdx(x+dx, y+dy);
            if(idx !== -1 && grid[idx] === 1) n++;
        }
    }
    return n;
}

function update() {
    let active = 0;
    const type = currentRule.type;
    const isLife = type === 'life';
    const isWire = type === 'wire';

    for (let i = 0; i < grid.length; i++) {
        // Fast coordinate calculation
        const x = i % config.cols;
        const y = Math.floor(i / config.cols);
        const s = grid[i];
        let ns = 0;

        if (isLife) {
            const n = countNeighbors(x, y, 'life');
            if (s === 1) ns = currentRule.S.includes(n) ? 1 : 0;
            else ns = currentRule.B.includes(n) ? 1 : 0;
        } else if (type === 'gens') {
            if (s === 0) ns = currentRule.B.includes(countNeighbors(x, y, 'gens')) ? 1 : 0;
            else if (s === 1) ns = currentRule.S.includes(countNeighbors(x, y, 'gens')) ? 1 : 2;
            else { ns = s + 1; if (ns >= currentRule.states) ns = 0; }
        } else if (isWire) {
            if (s === 1) ns = 2; else if (s === 2) ns = 3;
            else if (s === 3) {
                const n = countNeighbors(x, y, 'wire');
                ns = (n === 1 || n === 2) ? 1 : 3;
            } else ns = 0;
        }

        nextGrid[i] = ns;
        if(ns === 1) active++;
    }
    
    [grid, nextGrid] = [nextGrid, grid];
    generation++;
    document.getElementById('lbl-gen').innerText = generation;
    document.getElementById('lbl-pop').innerText = active;
    
    // Update Graph Data
    popHistory.push(active);
    popHistory.shift();
    updateGraph();
}

/* --- NEW GRAPH RENDERING --- */
function updateGraph() {
    const w = graphCanvas.width;
    const h = graphCanvas.height;
    graphCtx.clearRect(0, 0, w, h);

    const max = Math.max(...popHistory, 10);
    const min = Math.min(...popHistory);
    const range = max - min || 1;
    const stepX = w / (popHistory.length - 1);

    // 1. Draw Line
    graphCtx.beginPath();
    for(let i=0; i<popHistory.length; i++) {
        const y = h - ((popHistory[i] - min) / range) * (h - 4) - 2; // Keep 2px padding
        if(i===0) graphCtx.moveTo(0, y); else graphCtx.lineTo(i*stepX, y);
    }
    
    // Stroke
    graphCtx.strokeStyle = '#58a6ff';
    graphCtx.lineWidth = 1.5;
    graphCtx.stroke();

    // 2. Gradient Fill (Sparkline effect)
    graphCtx.lineTo(w, h);
    graphCtx.lineTo(0, h);
    const gradient = graphCtx.createLinearGradient(0, 0, 0, h);
    gradient.addColorStop(0, "rgba(88, 166, 255, 0.4)");
    gradient.addColorStop(1, "rgba(88, 166, 255, 0)");
    graphCtx.fillStyle = gradient;
    graphCtx.fill();

    // 3. Dot at the end
    const lastY = h - ((popHistory[popHistory.length-1] - min) / range) * (h - 4) - 2;
    graphCtx.beginPath();
    graphCtx.arc(w-2, lastY, 2, 0, Math.PI*2);
    graphCtx.fillStyle = '#fff';
    graphCtx.fill();
}

function draw() {
    // Fill background
    ctx.fillStyle = currentRule.colors[0];
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const sz = config.cellSize;
    // Si la cellule est assez grande (>4px), on laisse un pixel pour faire une grille (gap)
    const gap = sz > 4 ? 1 : 0; 

    for (let i = 0; i < grid.length; i++) {
        const s = grid[i];
        if (s > 0) {
            const x = (i % config.cols) * sz;
            const y = Math.floor(i / config.cols) * sz;
            
            ctx.fillStyle = currentRule.colors[s] || '#fff';
            // Dessin avec gap pour l'effet grille
            ctx.fillRect(x, y, sz - gap, sz - gap);
        }
    }
}

function resize() {
    const rect = document.getElementById('viewport').getBoundingClientRect();
    const w = Math.floor(rect.width - 20);
    const h = Math.floor(rect.height - 20);
    
    canvas.width = w; canvas.height = h;
    wrapper.style.width = w+"px"; wrapper.style.height = h+"px";

    config.cols = Math.ceil(w / config.cellSize);
    config.rows = Math.ceil(h / config.cellSize);
    
    grid = new Uint8Array(config.cols * config.rows);
    nextGrid = new Uint8Array(config.cols * config.rows);
    generation = 0; popHistory.fill(0);
    draw(); updateGraph();
}

function loop(t) {
    if(isPlaying && (t - lastTime > 1000/config.speed)) {
        update();
        draw();
        lastTime = t;
    }
    requestAnimationFrame(loop);
}

/* --- EVENTS --- */
ruleSelect.addEventListener('change', (e) => {
    currentRule = RULES[e.target.value];
    grid.fill(0); generation = 0; popHistory.fill(0);
    draw(); updateGraph();
});

patSelect.addEventListener('change', (e) => {
    const pid = e.target.value;
    if(!pid) return;
    const p = PATTERNS.find(x => x.id === pid);
    if(p.rule && p.rule !== ruleSelect.value) {
        ruleSelect.value = p.rule; currentRule = RULES[p.rule];
    }
    
    grid.fill(0); generation = 0;
    const cx = Math.floor(config.cols/2);
    const cy = Math.floor(config.rows/2);
    p.coords.forEach(([dx, dy, st]) => {
        let idx = getIdx(cx+dx-5, cy+dy-5); 
        if(idx !== -1) grid[idx] = st || 1;
    });
    draw();
    patSelect.value = "";
});

// Drawing interaction
let isDown = false;
const getGridPos = (e) => {
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return {
        x: Math.floor((clientX - rect.left) / config.cellSize),
        y: Math.floor((clientY - rect.top) / config.cellSize)
    };
};
const paint = (e) => {
    const {x, y} = getGridPos(e);
    const idx = getIdx(x, y);
    if(idx !== -1) {
        grid[idx] = (currentRule.type === 'wire') ? 3 : 1;
        draw();
    }
};

canvas.addEventListener('mousedown', () => isDown = true);
window.addEventListener('mouseup', () => isDown = false);
canvas.addEventListener('mousemove', (e) => { if(isDown) paint(e); });
canvas.addEventListener('click', paint);

canvas.addEventListener('touchstart', (e) => { isDown = true; paint(e); e.preventDefault(); }, {passive:false});
window.addEventListener('touchend', () => isDown = false);
canvas.addEventListener('touchmove', (e) => { if(isDown) paint(e); e.preventDefault(); }, {passive:false});

// Buttons
const btnPlay = document.getElementById('btn-play');
btnPlay.onclick = function() {
    isPlaying = !isPlaying;
    if(isPlaying) {
        this.innerHTML = "‚è∏ Pause";
        this.classList.add('is-playing');
    } else {
        this.innerHTML = "‚ñ∂ Lecture";
        this.classList.remove('is-playing');
    }
};

document.getElementById('btn-step').onclick = () => { update(); draw(); };
document.getElementById('btn-clear').onclick = () => { 
    grid.fill(0); generation = 0; popHistory.fill(0);
    document.getElementById('lbl-gen').innerText = '0';
    document.getElementById('lbl-pop').innerText = '0';
    draw(); updateGraph();
};

document.getElementById('btn-random').onclick = () => {
    const d = document.getElementById('range-density').value / 100;
    for(let i=0; i<grid.length; i++) grid[i] = Math.random() < d ? 1 : 0;
    generation = 0; draw();
};

document.getElementById('range-speed').oninput = (e) => {
    config.speed = e.target.value;
    document.getElementById('speed-val').innerText = config.speed + " fps";
};

document.getElementById('range-zoom').oninput = (e) => {
    config.cellSize = parseInt(e.target.value);
    document.getElementById('val-zoom').innerText = config.cellSize;
    resize();
};

document.getElementById('chk-wrap').onchange = (e) => config.wrap = e.target.checked;

// Init
window.addEventListener('resize', resize);
resize();
loop(0);

</script>
</body>
</html>
